{% extends 'exercise4/base.html'%}

{% block content %}
<div class="row">
	<div class="col-sm-5">
		{% if user.is_authenticated %}
			<h4>Welcome my friend {{ user.username }}!</h4>
		{% endif %}
	</div>
	<div class="col-sm-7 text-right">
		<form method="GET">
			<button class="btn btn-dark" name="export_info_csv">Export Info to CSV</button>
			<a class="btn btn-dark" href="{% url 'person_import' %}">Add Info via CSV</a>
			<button class="btn btn-dark" id="show_person_add_modal">Add Person Information <strong>+</strong></button>
		</form>
	</div>
</div>
<br>

{% if user.is_authenticated %}
	<div class="row">
		<div class="col-sm-12">
			<table class="welcomepagetable">
				<tr>
					<th>Profile Picture</th>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Contact Number</th>
					<th>Address</th>
					<th colspan="2">Actions</th>
				</tr>
				{% for person in person_list %}
					<tr>
						<td>
							{% if person.profilepicture %}
								<center><img style="height: 33px; width: 70px" src="{{ person.profilepicture.url }}"></center>
							{% else %}
								<p><center>NO IMAGE</center></p>
							{% endif %}
						</td>
						<td>{{person.first_name}}</td>
						<td>{{person.last_name}}</td>
						<td>{{person.contact_number}}</td>
						<td>{{person.address}}</td>
						<td>
							<a class="btn btn-default" href="{% url 'person_update' pk=person.pk %}">
								<span class="glyphicon glyphicon-pencil"></span>
							</a>
						</td>
						<td>
							<a class="btn btn-default" href="{% url 'person_delete' pk=person.pk %}">ORIG
							</a>
							<button class="btn btn-default" id="show_person_delete_modal">
								<span class="glyphicon glyphicon-trash"></span>
							</button>
						</td>
					</tr>
				{% endfor %}
			</table>
		</div>
	</div>
{% else %}
	<p>No data... Please login to view the list of Person Informations.</p>
{% endif %}

<!-- modal for add person information -->
<div class="modal fade" id="person_add_modal" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">Create Person Information</div>
			<div class="modal-body">
				<form method="POST" class="modal-form" enctype="multipart/form-data" data-url="{% url 'ajax_person_add' %}">
					{% csrf_token %}
					<table>
						{% for field in form %}
						<tr>
							<td>{{ field.label_tag }}</td>
							<td>{{ field }}</td>
							<td>{{ field.errors }}</td>
						</tr>
						{% endfor %}
						<tr>
							<td>
								<button class="btn btn-dark" data-dismiss="modal">Cancel</button>
								<button class="btn btn-dark" type="submit">Save</button>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
	</div>
</div>

<!-- modal for delete person information -->
<div class="modal fade" id="person_delete_modal" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-body">
				<p>Are you sure you want to delete information of {{person_data.first_name}} {{person_data.last_name}}?</p>
				<form method="POST" id="delete_form">
					{% csrf_token %}
					<button class="btn btn-dark" data-dismiss="modal">Cancel</button>
					<button class="btn btn-danger" type="submit">Confirm!</button>
				</form>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block js %}
<script>
$(document).ready(function(){
	$('#show_person_add_modal').on('click', showpersonaddmodal);
	$('#person_add_modal').on('submit', saveaddpersonform);

	$('#show_person_delete_modal').on('click', showpersondeletemodal);
	$('#person_delete_modal').on('click', savedeletepersonform);
});

function showpersonaddmodal(event){
	event.preventDefault();
	$('#person_add_modal').modal('show');
}

function showpersondeletemodal(event, element){
	event.preventDefault();
	$("#id_pk_delete").val($(element).attr("data-pk"));
	$('#person_delete_modal').modal('show');
}

function saveaddpersonform(event){
	event.preventDefault();
	var form = $('.modal-form');
	$.ajax({
		url:form.attr('data-url'),
		data:form.serialize(),
		type:form.attr('method'),
		dataType:'json',
		success:function(data){
			$('#person_add_modal').modal('hide');
			$('#id_first_name').val("");
			$('#id_last_name').val("");
			$('#id_contact_number').val("");
			$('#id_address').val("");
			$('#id_profilepicture').val("");
			refresh();
		}
	});
}

function savedeletepersonform(event){
	event.preventDefault();
}

function refresh(event){
	event.preventDefault();
	$.ajax({
		url: '/',
		type: 'GET',
		dataType: 'html',
		success: function(data){
			$('.welcomepagetable').html();
			console.log();
		}
	})
}
</script>
{% endblock %}